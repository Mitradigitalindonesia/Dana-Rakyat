<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Auto Trade Bot</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg-main: #f4f6f8;
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-subtle: #6b7280;
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --highlight: #0ea5e9;
      --border: #e5e7eb;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      margin: 0;
      padding: 0;
    }

    .app-header {
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      padding: 16px 20px;
      font-family: 'Orbitron', sans-serif;
      border-bottom: 1px solid var(--border);
      z-index: 999;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    .logo-text {
      font-size: 22px;
      font-weight: bold;
      font-style: italic;
      color: var(--highlight);
      letter-spacing: 1.5px;
    }

    .container {
      max-width: 700px;
      margin: auto;
      padding: 16px;
      padding-bottom: 120px;
    }

    .bot-header {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .portfolio-summary {
  background: linear-gradient(135deg, #0ea5e9, #0284c7);
  color: white;
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}
.portfolio-summary:hover {
  transform: translateY(-2px);
}
.portfolio-summary h2 {
  margin: 0;
  font-size: 32px;
  color: white;
}
.yield {
  color: #d1fae5; /* Hijau muda pastel */
  font-weight: 500;
  margin-top: 4px;
  font-size: 14px;
}

    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin: 12px 0 20px;
      gap: 8px;
    }
    .btn {
      flex: 1;
      padding: 12px;
      font-size: 14px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn:hover {
      background-color: var(--primary-dark);
    }

    .bot-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .bot-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .bot-card-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-main);
    }
    .profit {
      font-weight: bold;
    }
    .profit.green {
      color: #16a34a; /* hijau gelap */
    }
    .profit.red {
      color: #dc2626; /* merah */
    }

    .bot-info {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text-main);
    }

    .bot-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 8px;
      background-color: var(--border);
      color: var(--text-subtle);
    }

    .long {
      color: #16a34a;
    }
    .short {
      color: #dc2626;
    }

    .stop-btn {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      background-color: #dc2626;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    .stop-btn:hover {
      background-color: #b91c1c;
    }

    .start-btn {
      padding: 14px;
      background-color: var(--primary);
      width: 100%;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      color: white;
      margin-top: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .start-btn:hover {
      background-color: var(--primary-dark);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 99;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-main);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 16px;
      border-radius: 8px;
      width: 90%;
      max-width: 300px;
    }
    .form-group {
      margin-bottom: 8px;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
      color: var(--text-main);
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-main);
      color: var(--text-main);
      font-size: 12px;
    }
    .modal-footer {
      text-align: right;
      margin-top: 12px;
    }
    .close, .submit {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    }
    .close {
      background-color: var(--border);
      color: var(--text-subtle);
    }
    .submit {
      background-color: var(--primary);
      color: white;
    }
    .bot-card.green-bg {
  background-color: #ecfdf5; /* hijau muda */
}

.bot-card.red-bg {
  background-color: #fef2f2; /* merah muda */
}

.pnl-percentage {
  font-size: 13px;
  margin-top: 4px;
  font-weight: normal;
}

.pnl-percentage.green {
  color: #16a34a;
}

.pnl-percentage.red {
  color: #dc2626;
}
.bot-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.bot-icon {
  width: 90px;
  height: 120px;
  object-fit: contain;
  border-radius: 1px;
  margin-left: 3px;
}
.floating-add-btn {
  position: fixed;
  bottom: 70px; /* posisinya tetap */
  right: 16px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background-color: var(--bg-main);
  border: none;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 1000; /* di atas nav */
  transition: background-color 0.3s;
}

.floating-add-btn:hover {
  background-color: var(--highlight);
}

.floating-add-btn img {
  width: 36px;
  height: 36px;
  object-fit: contain;
  pointer-events: none; /* supaya klik tombol tetap diterima */
}
/* Bottom nav */
.bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card-bg); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:10px 0; z-index:1000; }
.bottom-nav a { color:var(--text-subtle); text-align:center; font-size:11px; text-decoration:none; display:flex; flex-direction:column; align-items:center; }
.bottom-nav a.active, .bottom-nav a:hover { color:var(--highlight); }
.bottom-nav a svg { width:24px; height:24px; margin-bottom:4px; }
*::before,
*::after {
  box-sizing: border-box;
}
  </style>
</head>
<body>

<div class="container">
  <div class="portfolio-summary">
    <div>Total Nilai Portofolio</div>
    <h2 id="totalBalance">Rpâ€¯0</h2>
    <div class="yield" id="totalYield">Total Keuntungan Rpâ€¯0</div>
  </div>

  <!-- âœ… Khusus untuk bot cards -->
  <div id="botsContainer"></div>
</div>

<!-- âœ… Modal dan tombol DILUAR dari container dan botsContainer -->
<div id="botModal" class="modal">
  <div class="modal-content">
    <div style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:9px;" onclick="closeModal()">Ã—</div>
    <div class="form-group">
  <label>Saldo Tersedia:</label>
  <div id="available-balance" style="font-weight: bold; color: #0284c7;">Rp 0</div>
</div>
    <div class="form-group">
      <label>Investasi (Rp):</label>
      <input type="number" id="investment" value="10000" />
    </div>
    <div class="form-group">
      <label>Tingkat Risiko:</label>
      <select id="risk-level" onchange="updateLeverageByRisk()">
        <option value="rendah">Rendah </option>
        <option value="sedang">Sedang </option>
        <option value="tinggi">Tinggi </option>
      </select>
    </div>
    <div class="form-group">
      <label>Tipe Posisi:</label>
      <select id="position-type">
        <option value="long">Long (Beli)</option>
        <option value="short">Short (Jual)</option>
      </select>
    </div>
    <div class="form-group">
      <label>AI Agent:</label>
      <select id="asset-select" onchange="changeAsset()">
        <option value="BTCUSDT">AI-Bitcoin</option>
        <option value="ETHUSDT">AI-Ethereum</option>
        <option value="PAXGUSDT">AI-Gold</option>
      </select>
    </div>
    <div class="modal-footer">
        <button class="close" onclick="closeModal()">Batal</button>
        <button class="submit" onclick="startBot()">Aktifkan</button>
      </div>
  </div>
</div>

<!-- âœ… Tombol tambah bot -->
<button class="floating-add-btn" onclick="openModal()">
  <img src="agen.png" alt="Add" />
</button>
<!-- âœ… Modal stop bot -->
<div id="stopBotModal" class="modal">
  <div class="modal-content">
    <div style="text-align: right; cursor: pointer; font-size: 18px;" onclick="closeStopModal()">Ã—</div>
    <h3 style="margin-top:0;">Kelola Bot</h3>

    <div class="form-group">
      <label>Profit / Loss (Rp):</label>
     <input 
  type="text" 
  id="manualProfit" 
  value="0" 
  placeholder="contoh: 5000 (profit) atau -3000 (rugi)"
/>

    <div class="modal-footer" style="display:flex; justify-content:space-between; gap:8px;">
      <button class="submit" onclick="saveBotProfit()">ðŸ’¾ Simpan</button>
      <button class="close" onclick="closeStopModal()">Batal</button>
      <button class="submit" style="background-color:#dc2626;" onclick="confirmStopBot()">ðŸ›‘ Hentikan</button>
    </div>
  </div>
</div>
   <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="dashboard.html" class="active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 10L12 3l8 7"></path>
        <path d="M5 11v9a1 1 0 001 1h4v-6h4v6h4a1 1 0 001-1v-9"></path>
      </svg>
      <span>Home</span>
    </a>
    <a href="akun.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="8" r="4"></circle>
        <path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path>
      </svg>
      <span>Akun</span>
    </a>
    <a href="dompet.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 7a2 2 0 012-2h16a1 1 0 011 1v2H4a2 2 0 00-2 2v8a2 2 0 002 2h16a1 1 0 001-1v-2h-6a2 2 0-2-2v-2a2 2 0-2-2h6V6a3 3 0-3-3H4a3 3 0-2 2.83V7z"></path>
        <circle cx="18" cy="12" r="1"></circle>
      </svg>
      <span>Dompet</span>
    </a>
    <a href="mitra.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 12l4-4 4 4-4 4-4-4z"></path>
        <path d="M20 12l-4-4-4 4 4 4 4-4z"></path>
      </svg>
      <span>Mitra</span>
    </a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://kibcrltcznvkbssgrinw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpYmNybHRjem52a2Jzc2dyaW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzAyNDksImV4cCI6MjA3MjU0NjI0OX0.LOX9fn-w1VwqiQJA4QxXsHResIQeVHf-0Rygn_x8U2w';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  function formatRupiah(number) {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0
    }).format(number || 0);
  }

let selectedBotToStop = null;

function openStopModal(botId) {
  selectedBotToStop = botId;

  // Isi default input Profit/Loss dari cache atau database
  document.getElementById('manualProfit').value = simulatedProfits[botId] ?? 0;

  document.getElementById('stopBotModal').style.display = 'block';
}

function closeStopModal() {
  selectedBotToStop = null;
  document.getElementById('stopBotModal').style.display = 'none';
}

// âœ… Simpan profit/lose manual tanpa menghentikan bot
async function saveBotProfit() {
  if (!selectedBotToStop) return;

  const manualProfit = parseFloat(document.getElementById('manualProfit').value.trim()) || 0;

  const { error } = await supabase
    .from('bots')
    .update({ profit: manualProfit })
    .eq('id', selectedBotToStop)
    .eq('user_id', currentUser.id);

  if (error) {
    alert("Gagal menyimpan profit/lose: " + error.message);
  } else {
    simulatedProfits[selectedBotToStop] = manualProfit; // update cache lokal
    updateBotCard({ id: selectedBotToStop, profit: manualProfit, status: 'aktif' });
    alert("Profit/Lose berhasil disimpan.");
    closeStopModal();
  }
}

async function confirmStopBot() {
  if (!selectedBotToStop) return;

  await stopBot(selectedBotToStop);
  closeStopModal();
}
  let currentUser = null;
  let activeBots = [];
  let simulatedProfits = {}; // Menyimpan PnL sementara per bot

  async function loadUser() {
    const { data: { session }, error } = await supabase.auth.getSession();
    if (error || !session || !session.user) {
      alert("Silakan login terlebih dahulu.");
      window.location.href = "login.html";
      return false;
    }
    currentUser = session.user;
    return true;
  }

  async function loadPortfolioSummary() {
  if (!currentUser) return;

  // Ambil saldo & penghasilan user
  const { data: profile, error: profileError } = await supabase
    .from('users')
    .select('penghasilan')
    .eq('id', currentUser.id)
    .single();

  if (profileError || !profile) {
    console.error("Gagal memuat data user:", profileError);
    return;
  }

  // Ambil semua bot aktif user
  const { data: bots, error: botsError } = await supabase
    .from('bots')
    .select('investasi, profit')
    .eq('user_id', currentUser.id)
    .eq('status', 'aktif');

  if (botsError) {
    console.error("Gagal memuat data bot:", botsError);
    return;
  }

  let totalInvestasi = 0;
  let totalProfit = 0;

  bots.forEach(bot => {
    totalInvestasi += bot.investasi || 0;
    totalProfit += bot.profit || 0;
  });

  const totalPortofolio = totalInvestasi + totalProfit;

  document.getElementById('totalBalance').textContent = formatRupiah(totalPortofolio);
  document.getElementById('totalYield').textContent = 'Total Keuntungan ' + formatRupiah(profile.penghasilan || 0);
}
  function createBotCard(bot) {
  const card = document.createElement('div');
  card.className = 'bot-card';
  card.setAttribute('data-bot-id', bot.id);

  const profit = bot.profit || 0;
  const investasi = bot.investasi || 1;
  const pnlPercent = (profit / investasi) * 100;
  const formattedPercent = (pnlPercent >= 0 ? '+' : '') + pnlPercent.toFixed(2) + '%';
  const pnlColor = pnlPercent >= 0 ? 'green' : 'red';

  if (pnlPercent >= 0.01) {
    card.classList.add('green-bg');
  } else if (pnlPercent <= -0.01) {
    card.classList.add('red-bg');
  }

  card.innerHTML = `
    <div style="display: flex; align-items: center; gap: 3px;">
      <img src="${getBotIconByLeverage(bot.leverage)}" alt="Bot Icon" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px;">
      <div style="display: flex; justify-content: space-between; width: 100%; font-size: 13px;">
        <div>
          <div>Investasi</div>
          <strong>${formatRupiah(bot.investasi)}</strong>
        </div>
        <div style="text-align: right;">
          <div>Laba Rugi</div>
          <strong class="profit">${formatRupiah(profit)}</strong>
          <div class="pnl-percentage ${pnlColor}">${formattedPercent}</div>
        </div>
      </div>
    </div>
  `;

  // Tambahkan event click untuk membuka modal stop
  card.addEventListener('click', () => openStopModal(bot.id));

  return card;
}
  function renderBots(bots) {
    const container = document.getElementById('botsContainer');
    container.innerHTML = '';
    bots.forEach(bot => container.appendChild(createBotCard(bot)));
  }

  function prependBot(bot) {
    const container = document.getElementById('botsContainer');
    container.prepend(createBotCard(bot));
  }

  function updateBotCard(bot) {
  const card = document.querySelector(`[data-bot-id="${bot.id}"]`);
  if (!card) return;

  const profitElem = card.querySelector('.profit');
  const pnlElem = card.querySelector('.pnl-percentage');

  const statusElem = card.querySelector('.status');
  if (statusElem) statusElem.textContent = bot.status || 'aktif';

  const profit = bot.profit || 0;
  const investasi = activeBots.find(b => b.id === bot.id)?.investasi || 1; // fallback 1 biar ga dibagi 0

  // Hitung PnL %
  const pnlPercent = (profit / investasi) * 100;
  const formattedPercent = (pnlPercent > 0 ? '+' : '') + pnlPercent.toFixed(2) + '%';

  // Update teks
  if (profitElem) profitElem.textContent = formatRupiah(profit);
  if (pnlElem) {
    pnlElem.textContent = formattedPercent;
    pnlElem.className = 'pnl-percentage ' + (pnlPercent >= 0 ? 'green' : 'red');
  }

  // Update warna background
  card.classList.remove('green-bg', 'red-bg');
  if (pnlPercent >= 0.01) {
    card.classList.add('green-bg');
  } else if (pnlPercent <= -0.01) {
    card.classList.add('red-bg');
  }
}

  async function loadBotsAndSubscribe() {
    if (!await loadUser()) return;

    await loadPortfolioSummary();

    const { data: bots, error } = await supabase
  .from('bots')
  .select('*')
  .eq('user_id', currentUser.id)
  .eq('status', 'aktif') // âœ… Tambahkan ini
  .order('created_at', { ascending: false });

    if (error) {
      console.error("Error fetch bots:", error.message);
    } else {
      renderBots(bots);
      activeBots = bots;
      bots.forEach(bot => {
        simulatedProfits[bot.id] = bot.profit ?? 0;
      });
    }

    const channel = supabase
      .channel('bots_changes_user_' + currentUser.id)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'bots',
        filter: `user_id=eq.${currentUser.id}`
      }, payload => {
        prependBot(payload.new);
        activeBots.unshift(payload.new);
        simulatedProfits[payload.new.id] = payload.new.profit ?? 0;
      })
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'bots',
        filter: `user_id=eq.${currentUser.id}`
      }, payload => {
        updateBotCard(payload.new);
        // Jika status berubah menjadi "berhenti", hapus dari activeBots
        if (payload.new.status === 'berhenti') {
          activeBots = activeBots.filter(bot => bot.id !== payload.new.id);
          delete simulatedProfits[payload.new.id];
        }
      })
      .subscribe();
  }

  async function startBot() {
  if (!currentUser) {
    if (!await loadUser()) return;
  }

  const investment = parseFloat(document.getElementById('investment').value);
  const leverage = updateLeverageByRisk();
  const posisi = document.getElementById('position-type').value;
  const asset = document.getElementById('asset-select').value;
  const hargaBeli = 1; // default harga 1 unit

  if (isNaN(investment) || investment <= 0) {
    alert("Investasi harus lebih dari 0.");
    return;
  }
  if (isNaN(leverage) || leverage <= 0) {
    alert("Leverage harus lebih dari 0.");
    return;
  }
  if (!hargaBeli) {
    alert("Gagal mengambil harga aset.");
    return;
  }

  const jumlah = investment / hargaBeli;

  // Ambil saldo user
  const { data: profile, error: saldoError } = await supabase
    .from('users')
    .select('saldo')
    .eq('id', currentUser.id)
    .single();

  if (saldoError || !profile) {
    alert("Gagal mengambil saldo user.");
    return;
  }

  if (profile.saldo < investment) {
    alert("Saldo tidak mencukupi.");
    return;
  }

  // Kurangi saldo user
  const { error: updateSaldoError } = await supabase
    .from('users')
    .update({ saldo: profile.saldo - investment })
    .eq('id', currentUser.id);

  if (updateSaldoError) {
    alert("Gagal mengurangi saldo user.");
    return;
  }

  // Insert bot baru
  const { error: insertError } = await supabase
    .from('bots')
    .insert([{
      user_id: currentUser.id,
      asset,
      investasi: investment,
      leverage,
      posisi,
      harga_beli: hargaBeli,
      jumlah,
      status: 'aktif',
      profit: 0
    }]);

  if (insertError) {
    alert("Gagal membuat bot: " + insertError.message);
  } else {
    alert("Bot berhasil dibuat.");
    closeModal();
    await loadBotsAndSubscribe();   // reload bot
    await loadPortfolioSummary();   // reload saldo & profit
  }
}
function updateLeverageByRisk() {
  const risk = document.getElementById('risk-level').value;
  let leverage = 1;
  if (risk === 'sedang') leverage = 5;
  else if (risk === 'tinggi') leverage = 25;
  return leverage;
}

function getBotIconByLeverage(leverage) {
  if (leverage >= 25) return 'bot3.png';
  if (leverage >= 5) return 'bot2.png';
  return 'bot1.png';
}
  async function stopBot(botId) {
  // Ambil data bot dari database
  const { data: bot, error: fetchError } = await supabase
    .from('bots')
    .select('*')
    .eq('id', botId)
    .eq('user_id', currentUser.id)
    .single();

  if (fetchError) {
    alert("Gagal ambil bot: " + fetchError.message);
    return;
  }

  // Ambil profit terbaru dari UI
  const card = document.querySelector(`[data-bot-id="${botId}"]`);
  const profitText = card?.querySelector('.profit')?.textContent || "Rp0";
  const cleanProfit = simulatedProfits[botId] ?? bot.profit ?? 0;

  const totalReturn = bot.investasi + cleanProfit;

  // Ambil saldo user
  const { data: profile, error: saldoError } = await supabase
    .from('users')
    .select('saldo, penghasilan')
    .eq('id', currentUser.id)
    .single();

  if (saldoError) {
    alert("Gagal ambil saldo user: " + saldoError.message);
    return;
  }

  const newSaldo = profile.saldo + totalReturn;
  const newProfit = (profile.penghasilan || 0) + cleanProfit;

  // Update saldo & penghasilan user
  const { error: updateUserError } = await supabase
    .from('users')
    .update({
      saldo: newSaldo,
      penghasilan: newProfit
    })
    .eq('id', currentUser.id);

  if (updateUserError) {
    alert("Gagal update saldo user: " + updateUserError.message);
    return;
  }

  // Update status bot & simpan nilai profit terakhir
  const { error } = await supabase
    .from('bots')
    .update({ status: 'berhenti', profit: cleanProfit })
    .eq('id', botId)
    .eq('user_id', currentUser.id);

  if (error) {
    alert("Gagal update bot: " + error.message);
  } else {
    alert("Bot dihentikan.");
    await loadPortfolioSummary(); // refresh UI saldo
    loadBotsAndSubscribe(); // hapus dari tampilan
  }
}

  async function openModal() {
  document.getElementById('botModal').style.display = 'block';

  // Ambil saldo user dan tampilkan
  if (!currentUser) {
    if (!await loadUser()) return;
  }

  const { data: profile, error } = await supabase
    .from('users')
    .select('saldo')
    .eq('id', currentUser.id)
    .single();

  if (error || !profile) {
    document.getElementById('available-balance').textContent = "Gagal memuat saldo";
    return;
  }

  document.getElementById('available-balance').textContent = formatRupiah(profile.saldo || 0);
}

  function closeModal() {
  document.getElementById('botModal').style.display = 'none';
  document.getElementById('available-balance').textContent = 'Rp 0';
}
  function startProfitSimulation() {
  setInterval(async () => {
    if (!currentUser) return;

    const { data: bots, error } = await supabase
      .from('bots')
      .select('id, investasi, leverage')
      .eq('user_id', currentUser.id)
      .eq('status', 'aktif');

    if (error) {
      console.error('Gagal ambil bot untuk simulasi:', error);
      return;
    }

    for (const bot of bots) {
      // Pakai profit dari cache, jangan paksa 0
      const prevProfit = simulatedProfits[bot.id] ?? bot.profit ?? 0;

      const win = Math.random() < 0.49;
      const direction = win ? 1.015 : -1.2536;
      const baseChange = bot.investasi * 0.0001; 
      const leverage = bot.leverage || 1;
      const change = baseChange * leverage * direction;

      const newProfit = prevProfit + change;

      simulatedProfits[bot.id] = newProfit;

      updateBotCard({ id: bot.id, profit: newProfit, status: 'aktif' });
    }
  }, 1000);
}
function saveSimulatedProfitsPeriodically() {
  setInterval(async () => {
    for (const [botId, profit] of Object.entries(simulatedProfits)) {
      const { error } = await supabase
        .from('bots')
        .update({ profit })
        .eq('id', botId);

      if (error) {
        console.error('Gagal update profit bot:', botId, error);
      }
    }
  }, 100000);
}
  // Simpan ke database saat user keluar
  window.addEventListener('beforeunload', async (event) => {
    const updates = Object.entries(simulatedProfits).map(([botId, profit]) => ({
      id: botId,
      profit
    }));

    for (const update of updates) {
      await supabase
        .from('bots')
        .update({ profit: update.profit })
        .eq('id', update.id);
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
  loadBotsAndSubscribe();
  startProfitSimulation();
  saveSimulatedProfitsPeriodically();
});
  </script>
</body>
  </html>
