<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Portfolio Investasi</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet" />
<style>
:root {
  --bg-main: #f9fafb;
  --card-bg: #ffffff;
  --text-main: #1f2937;
  --text-subtle: #6b7280;
  --primary: #0ea5e9;
  --highlight: #0ea5e9;
  --profit: #22c55e;
  --loss: #ef4444;
  --border: #e5e7eb;
}
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--bg-main); color:var(--text-main); margin:0; }
.container { max-width:470px; margin:auto; padding:16px; padding-bottom:70px; }
.portfolio-summary {
  background: linear-gradient(135deg,#0ea5e9,#0284c7);
  color:#fff; border-radius:16px; padding:20px; margin-bottom:16px; text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.summary-title { font-size:14px; margin-bottom:6px; }
.summary-value { font-size:20px; font-weight:bold; }
.summary-sub { font-size:12px; font-weight:500; margin-top:4px; }
.asset-list { display:flex; flex-direction:column; gap:10px; }
.asset-card {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 16px; border-radius:12px; background:#fff;
  box-shadow:0 1px 4px rgba(0,0,0,0.05);
  cursor:pointer;
}
.asset-left { display:flex; flex-direction:column; }
.asset-left .name { font-weight:bold; font-size:13px; }
.asset-left .desc { font-size:11px; color:var(--text-subtle); }
.asset-right { text-align:right; font-size:12px; }
.asset-right .aum { font-weight:bold; font-size:13px; }
.asset-right .return { font-weight:bold; }
.allocation-wrapper { display:flex; gap:16px; align-items:center; margin-bottom:16px; }
.chart-container { width:180px !important; height:180px !important; flex-shrink:0; }
.allocation-list { display:flex; flex-direction:column; gap:6px; font-size:11px; }
.allocation-list .asset { display:flex; justify-content:space-between; align-items:center; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.modal-close { background:none; border:none; font-size:20px; cursor:pointer; }
.balance-info { display:flex; justify-content:space-between; font-size:13px; margin:10px 0; color:var(--text-main); }
.modal-actions { display:flex; gap:10px; margin-top:15px; }
.btn-buy { flex:1; background:var(--profit); color:#fff; padding:10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
.btn-sell { flex:1; background:var(--loss); color:#fff; padding:10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
.bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card-bg); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:10px 0; z-index:1200; }
.bottom-nav a { color:var(--text-subtle); text-align:center; font-size:11px; text-decoration:none; display:flex; flex-direction:column; align-items:center; }
.bottom-nav a.active, .bottom-nav a:hover { color:var(--highlight); }
.bottom-nav a svg { width:24px; height:24px; margin-bottom:4px; }
*::before,*::after { box-sizing: border-box; }
</style>
</head>
<body>
<div class="container">
  <div class="portfolio-summary">
    <div class="summary-title">Total Nilai Portofolio</div>
    <div class="summary-value" id="totalAum">Rp 0</div>
    <div class="summary-sub">Laba/Rugi Total: <span id="avgReturn">Rp 0</span></div>
  </div>
  <div class="allocation-wrapper">
    <canvas id="allocationChart" class="chart-container"></canvas>
    <div id="allocationList" class="allocation-list"></div>
  </div>
  <div id="assetList" class="asset-list">Memuat data...</div>
</div>

<div class="modal" id="investModal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="modalTitle">Investasi</span>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div id="modalInfo" style="font-size:13px; margin:10px 0; color:var(--text-subtle);"></div>
    <div class="balance-info">
      <div>SALDO : <span id="userSaldo">Rp 0</span></div>
      <div>Unit Anda : <span id="userUnit">0</span></div>
      <div>Stok Tersedia : <span id="stokTersedia">0</span></div>
    </div>
    <div>
      <label for="tradeUnit" style="font-size:13px;font-weight:bold;">Jumlah Unit</label>
      <input id="tradeUnit" type="number" step="0.0001" min="0.0001" placeholder="0.0001"
        style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:6px;margin-top:6px;" />
      <div id="tradeInfo" style="margin-top:6px;font-size:12px;color:var(--text-subtle);">Masukkan jumlah unit</div>
    </div>
    <div class="modal-actions">
      <button class="btn-buy" id="btnBuy">Beli</button>
      <button class="btn-sell" id="btnSell">Jual</button>
    </div>
  </div>
</div>

<div class="bottom-nav">
  <a href="dashboard.html"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M4 10L12 3l8 7"></path><path d="M5 11v9a1 1 0 001 1h4v-6h4v6h4a1 1 0 001-1v-9"></path></svg><span>Home</span></a>
  <a href="akun.html"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="8" r="4"></circle><path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path></svg><span>Akun</span></a>
  <a href="dompet.html"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M2 7a2 2 0 012-2h16a1 1 0 011 1v2H4a2 2 0 00-2 2v8a2 2 0 002 2h16a2 2 0 001-1v-2h-6a2 2 0-2-2v-2a2 2 0-2-2h6V6a3 3 0-3-3H4a3 3 0-2 2.83V7z"></path><circle cx="18" cy="12" r="1"></circle></svg><span>Dompet</span></a>
  <a href="mitra.html"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M4 12l4-4 4 4-4 4-4-4z"></path><path d="M20 12l-4-4-4 4 4 4 4-4z"></path></svg><span>Mitra</span></a>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const SUPABASE_URL = "https://kibcrltcznvkbssgrinw.supabase.co";
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpYmNybHRjem52a2Jzc2dyaW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzAyNDksImV4cCI6MjA3MjU0NjI0OX0.LOX9fn-w1VwqiQJA4QxXsHResIQeVHf-0Rygn_x8U2w';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const formatRupiah = (num) => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR'}).format(num||0);
  const colors = ["#0ea5e9","#f59e0b","#22c55e","#ef4444","#8b5cf6"];
  let allocationChart = null;
  let selectedProduk = null;
  
  const { data: { user }, error: authErr } = await supabase.auth.getUser();
  if(authErr || !user){ alert("Silakan login dulu."); return; }
  let currentUser = user;

  async function loadPortfolio() {
  let { data, error } = await supabase
    .from('project_investment')
    .select(`
      id,
      nama_produk,
      nab,
      return_value,
      stok_unit,
      jumlah_unit,
      aum,
      project_investment_user!left (
        jumlah_unit,
        avg_nab,
        produk_id
      )
    `)
    .eq('project_investment_user.user_id', currentUser.id);

  if (error) {
    console.error(error);
    return;
  }

  let totalAum = 0;
  let totalProfitLoss = 0;
  const labels = [], values = [];
  const list = document.getElementById('assetList');
  list.innerHTML = '';

  data.forEach((row) => {
    const userInv = row.project_investment_user?.find(p => p.produk_id === row.id) || {};
    const jumlah_unit = userInv.jumlah_unit || 0;
    const avg_nab = userInv.avg_nab || 0;
    const aum = jumlah_unit * row.nab;
    const ret = row.return_value ? parseFloat(row.return_value) * 100 : 0;

    if (jumlah_unit > 0) {
      totalAum += aum;
      const investedValue = jumlah_unit * avg_nab;
      const profitLoss = aum - investedValue;
      totalProfitLoss += profitLoss;

      labels.push(row.nama_produk);
      values.push(aum);
    }

    const div = document.createElement("div");
    div.className = "asset-card";
    div.innerHTML = `
      <div class="asset-left">
        <div class="name">${row.nama_produk}</div>
        <div class="desc">NAB: ${formatRupiah(row.nab)} | Unit: ${jumlah_unit.toFixed(4)}</div>
      </div>
      <div class="asset-right">
        <div class="aum">${formatRupiah(aum)}</div>
        <div class="return" style="color:${ret >= 0 ? 'var(--profit)' : 'var(--loss)'}">
          ${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%
        </div>
      </div>
    `;
    div.addEventListener('click', () => openModal({ ...row, jumlah_unit, avg_nab }));
    list.appendChild(div);
  });

  document.getElementById('totalAum').textContent = formatRupiah(totalAum);
  const sign = totalProfitLoss >= 0 ? '+' : '';
  document.getElementById('avgReturn').textContent = `${sign}${formatRupiah(totalProfitLoss)}`;

  if (allocationChart) allocationChart.destroy();
  const ctx = document.getElementById('allocationChart');

  // ✅ Fallback jika tidak ada investasi
  if (labels.length === 0) {
    labels.push('Belum ada investasi');
    values.push(1);
  }

  allocationChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map((_, i) => colors[i % colors.length])
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });

  const allocationList = document.getElementById("allocationList");
  allocationList.innerHTML = "";

  const totalValue = values.reduce((a, b) => a + b, 0);

  labels.forEach((label, i) => {
    const percent = totalValue > 0 ? ((values[i] / totalValue) * 100).toFixed(1) : '0.0';
    const color = colors[i % colors.length];
    const div = document.createElement("div");
    div.className = "asset";
    div.innerHTML = `<span style="color:${color}">${label}</span><span style="color:${color}">${percent}%</span>`;
    allocationList.appendChild(div);
  });
}
  async function openModal(produk){
  selectedProduk = produk;
  document.getElementById('modalTitle').textContent = produk.nama_produk;
  document.getElementById('modalInfo').textContent = `NAB: ${formatRupiah(produk.nab)} | Return: ${produk.return_value?.toFixed(2)}%`;

  let { data: userData } = await supabase
    .from('users')
    .select('saldo')
    .eq('id', currentUser.id)
    .single();
  document.getElementById('userSaldo').textContent = formatRupiah(userData?.saldo || 0);

  let { data: pu } = await supabase
    .from('project_investment_user')
    .select('jumlah_unit')
    .eq('user_id', currentUser.id)
    .eq('produk_id', produk.id)
    .single();
  document.getElementById('userUnit').textContent = pu?.jumlah_unit ? pu.jumlah_unit.toFixed(4) : '0';

  // ✅ Tambahkan ini:
  document.getElementById('stokTersedia').textContent = produk.stok_unit?.toFixed(4) || '0';

  document.getElementById('investModal').style.display = "flex";
}

  async function handleTrade(side) {
  if (!selectedProduk) return;

  const unit = parseFloat(document.getElementById('tradeUnit').value);
  if (isNaN(unit) || unit <= 0) {
    alert("Jumlah unit tidak valid");
    return;
  }

  const total = unit * selectedProduk.nab;
  const feePercent = 0.005;
  const feeAmount = total * feePercent;

  // Ambil saldo user
  const { data: userData, error: saldoErr } = await supabase
    .from('users')
    .select('saldo')
    .eq('id', currentUser.id)
    .single();

  if (saldoErr || !userData) {
    alert("Gagal mengambil data saldo.");
    return;
  }

  let saldo = parseFloat(userData.saldo);

  // Ambil data produk terbaru
  const { data: produk, error: produkErr } = await supabase
    .from('project_investment')
    .select('*')
    .eq('id', selectedProduk.id)
    .single();

  if (produkErr || !produk) {
    alert("Produk tidak ditemukan.");
    return;
  }

  // Ambil data user pada produk
  const { data: userInvest } = await supabase
    .from('project_investment_user')
    .select('*')
    .eq('user_id', currentUser.id)
    .eq('produk_id', produk.id)
    .single();

  let newUserUnit = 0;
  let newAvgNab = produk.nab;

  if (side.toUpperCase() === "BUY") {
    if (saldo < (total + feeAmount)) {
      alert("Saldo tidak cukup.");
      return;
    }

    if (produk.stok_unit < unit) {
      alert("Stok tidak mencukupi.");
      return;
    }

    saldo -= (total + feeAmount);

    if (userInvest) {
      newUserUnit = userInvest.jumlah_unit + unit;
      newAvgNab = ((userInvest.avg_nab * userInvest.jumlah_unit) + (produk.nab * unit)) / newUserUnit;

      await supabase.from('project_investment_user')
        .update({
          jumlah_unit: newUserUnit,
          avg_nab: newAvgNab
        })
        .eq('id', userInvest.id);
    } else {
      newUserUnit = unit;
      await supabase.from('project_investment_user')
        .insert({
          user_id: currentUser.id,
          produk_id: produk.id,
          jumlah_unit: newUserUnit,
          avg_nab: newAvgNab
        });
    }

    produk.jumlah_unit += unit;
    produk.stok_unit -= unit;
    produk.aum += (total + feeAmount);
  }

  if (side.toUpperCase() === "SELL") {
    if (!userInvest || userInvest.jumlah_unit < unit) {
      alert("Unit tidak mencukupi.");
      return;
    }

    saldo += (total - feeAmount);

    newUserUnit = userInvest.jumlah_unit - unit;

    if (newUserUnit > 0) {
      await supabase.from('project_investment_user')
        .update({ jumlah_unit: newUserUnit })
        .eq('id', userInvest.id);
    } else {
      // ❗JANGAN DELETE, hanya set ke 0 agar tidak hilang dari tabel
      await supabase.from('project_investment_user')
        .update({ jumlah_unit: 0 })
        .eq('id', userInvest.id);
    }

    produk.jumlah_unit -= unit;
    produk.stok_unit += unit;
    produk.aum = produk.aum - total + feeAmount;

    // ❗ Opsional: Cegah jumlah_unit <= 0
    if (produk.jumlah_unit <= 0) {
      alert("Tidak bisa menjual seluruh unit. Setidaknya harus tersisa 0.0001 unit di sistem.");
      return;
    }
  }

  // Update produk
  await supabase.from('project_investment')
    .update({
      jumlah_unit: Math.max(0, produk.jumlah_unit),
      stok_unit: Math.max(0, produk.stok_unit),
      aum: Math.max(0, produk.aum)
    })
    .eq('id', produk.id);

  // Update saldo user
  await supabase.from('users')
    .update({ saldo })
    .eq('id', currentUser.id);
await supabase.from('investment_log').insert({
  user_id: currentUser.id,
  produk_id: produk.id,
  tipe: side.toUpperCase(),
  jumlah_unit: unit,
  harga_nab: produk.nab,
  total: total,
  fee: feeAmount,
  saldo_setelah: saldo
});
  alert(`${side.toUpperCase()} ${unit.toFixed(4)} unit ${produk.nama_produk} berhasil.`);

  document.getElementById('investModal').style.display = "none";
  document.getElementById('tradeUnit').value = "";
  loadPortfolio();
}

  document.getElementById('btnBuy').addEventListener('click', () => handleTrade('BUY'));
  document.getElementById('btnSell').addEventListener('click', () => handleTrade('SELL'));
  document.getElementById('modalClose').addEventListener('click', () => {
    document.getElementById('investModal').style.display = 'none';
  });

  loadPortfolio();
});
</script>
</body>
</html>
